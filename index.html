<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto da Ação Educativa em EJA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Custom styles and animations */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F7F9FC;
        }
        
        .card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.7s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease-out;
            opacity: 0;
            visibility: hidden;
        }

        .card.expanded .card-content {
            max-height: 2000px; /* Adjust as needed for content */
            opacity: 1;
            visibility: visible;
        }

        .card .summary-content {
            display: block;
        }

        .card.expanded .summary-content {
            display: none;
        }

        .action-button {
            background-image: linear-gradient(to right, #4A90E2, #7B61FF);
        }

        .action-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .loader {
            border-top-color: #2F3C7E;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Notification Modal -->
    <div id="notification" class="fixed top-5 right-5 bg-red-500 text-white py-3 px-6 rounded-2xl shadow-lg transition-transform transform translate-x-[150%] z-50">
        <p id="notification-message"></p>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
        <p class="text-white text-xl ml-4">Gerando PDF...</p>
    </div>

    <!-- Header / Menu -->
    <header class="bg-white shadow-sm sticky top-0 z-40 py-4 px-4 sm:px-8">
        <div class="container mx-auto flex justify-between items-center gap-4">
            <h1 class="text-xl sm:text-2xl font-bold text-[#2F3C7E] whitespace-nowrap">Projeto EJA</h1>
            
            <!-- Desktop Menu -->
            <nav class="hidden md:flex flex-1 justify-end items-center gap-2">
                <input type="search" id="search-input-desktop" placeholder="Buscar..." class="w-full max-w-xs px-4 py-2 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-[#4A90E2] focus:outline-none transition">
                <button id="import-json-btn-desktop" class="action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md transition-transform duration-300 text-sm">Importar JSON</button>
                <button id="export-json-btn-desktop" class="action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md transition-transform duration-300 text-sm">Exportar JSON</button>
                <button id="export-pdf-btn-desktop" class="action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md transition-transform duration-300 text-sm">Exportar PDF</button>
                <button id="share-pdf-btn-desktop" class="action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md transition-transform duration-300 text-sm hidden">Compartilhar PDF</button>
            </nav>

            <!-- Mobile Menu Button -->
            <div class="md:hidden">
                <button id="mobile-menu-button" class="p-2 rounded-md text-[#2F3C7E] focus:outline-none focus:ring-2 focus:ring-inset focus:ring-[#4A90E2]">
                    <svg class="h-6 w-6" id="menu-open-icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    <svg class="h-6 w-6 hidden" id="menu-close-icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>

        <!-- Mobile Menu Panel -->
        <div id="mobile-menu" class="md:hidden hidden bg-white shadow-lg absolute top-full right-0 w-full">
            <div class="px-4 pt-2 pb-4 space-y-3">
                 <input type="search" id="search-input-mobile" placeholder="Buscar..." class="w-full px-4 py-2 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-[#4A90E2] focus:outline-none transition">
                 <button id="import-json-btn-mobile" class="w-full text-left action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md">Importar JSON</button>
                 <button id="export-json-btn-mobile" class="w-full text-left action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md">Exportar JSON</button>
                 <button id="export-pdf-btn-mobile" class="w-full text-left action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md">Exportar PDF</button>
                 <button id="share-pdf-btn-mobile" class="w-full text-left action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md hidden">Compartilhar PDF</button>
            </div>
        </div>
        <input type="file" id="json-file-input" class="hidden" accept=".json">
    </header>

    <!-- Main Content -->
    <main id="project-form" class="container mx-auto p-4 sm:p-8">
        <!-- Cards will be dynamically inserted here by JavaScript -->
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const formContainer = document.getElementById('project-form');
            
            // Structure of the project sections
            const sections = [
                { id: 'identificacao', title: '1. Identificação do Projeto da Ação Educativa em EJA', info: 'Preencha os dados de identificação do estagiário e do local da ação.', fields: [
                    { id: 'estagiario', label: 'Estagiário(a)', type: 'input' },
                    { id: 'local_acao', label: 'Local da ação educativa', type: 'input' },
                    { id: 'gestor_local', label: 'Gestor do local da ação educativa', type: 'input' },
                    { id: 'endereco', label: 'Endereço', type: 'input' }
                ]},
                { id: 'introducao', title: '2. Introdução', info: 'Descreva o local da ação, seu histórico, estrutura física, humana e a atuação da gestão.', fields: [{ id: 'introducao_text', type: 'textarea' }] },
                { id: 'objetivos', title: '3. Objetivos', info: 'Defina o que se pretende alcançar com o projeto.', fields: [
                    { id: 'objetivo_geral', label: '3.1 Objetivo Geral', info: 'Informe um objetivo de forma geral (Ex: Contribuir, Possibilitar...).', type: 'textarea' },
                    { id: 'objetivos_especificos', label: '3.2 Objetivos Específicos', info: 'Informe três objetivos de forma específica.', type: 'textarea' }
                ]},
                { id: 'justificativa', title: '4. Justificativa do Tema do Projeto', info: 'Descreva as observações e dificuldades encontradas que levaram à escolha do tema.', fields: [{ id: 'justificativa_text', type: 'textarea' }] },
                { id: 'revisao_literatura', title: '5. Revisão da Literatura', info: 'Fundamente teoricamente o tema do projeto com base em autores e obras relevantes.', fields: [{ id: 'revisao_literatura_text', type: 'textarea' }] },
                { id: 'metodologia', title: '6. Metodologia', info: 'Mencione o que, como, quando e onde você vai aplicar sua ação educativa.', fields: [{ id: 'metodologia_text', type: 'textarea' }] },
                { id: 'acao_educativa', title: '7. Ação Educativa – Onde, Quando, O que e Com Quem foi aplicada', info: 'Detalhe a aplicação da sua ação educativa.', fields: [
                    { id: 'data_acao', label: 'Data', type: 'input' },
                    { id: 'publico_alvo', label: 'Público-alvo', type: 'input' },
                    { id: 'turno', label: 'Turno', type: 'input' },
                    { id: 'semestre_atual', label: 'Semestre atual', type: 'input' },
                    { id: 'local_aplicacao', label: 'Local', type: 'input' },
                    { id: 'titulo_projeto', label: 'Título do projeto (campo obrigatório)', type: 'input', required: true }
                ]},
                { id: 'recursos', title: '7.1 Recursos a serem utilizados', info: 'Liste todos os materiais e recursos que serão usados na ação educativa.', fields: [{ id: 'recursos_text', type: 'textarea' }] },
                { id: 'referencias', title: 'Referências utilizadas', info: 'Liste todas as referências (livros, textos) usadas na construção do projeto, seguindo as normas da ABNT.', fields: [{ id: 'referencias_text', type: 'textarea' }] },
                { id: 'avaliacao', title: '8. Avaliação', info: 'Descreva como os resultados do projeto serão avaliados.', fields: [{ id: 'avaliacao_text', type: 'textarea' }] },
                { id: 'resultados_esperados', title: '9. Resultados esperados', info: 'Descreva o que se espera alcançar e melhorar com a aplicação do projeto.', fields: [{ id: 'resultados_esperados_text', type: 'textarea' }] },
                { id: 'anexos_apendices', title: 'Anexos/Apêndices', info: 'Anexos: materiais prontos utilizados. Apêndices: materiais produzidos por você (fotos, atividades).', fields: [{ id: 'anexos_apendices_text', type: 'textarea' }] }
            ];

            let projectData = {};

            function createCardHTML(section) {
                const fieldsHTML = section.fields.map(field => `
                    <div class="mb-4">
                        ${field.label ? `<label for="${field.id}" class="block text-md font-semibold text-[#2F3C7E] mb-2">${field.label}${field.required ? '<span class="text-red-500">*</span>' : ''}</label>` : ''}
                        ${field.info && field.label ? `<p class="text-sm text-gray-500 mb-2">${field.info}</p>` : ''}
                        ${field.type === 'input' ? 
                            `<input type="text" id="${field.id}" data-section="${section.id}" class="w-full p-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-[#4A90E2] focus:outline-none transition bg-gray-50">` : 
                            `<textarea id="${field.id}" data-section="${section.id}" rows="8" class="w-full p-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-[#4A90E2] focus:outline-none transition bg-gray-50"></textarea>`
                        }
                    </div>
                `).join('');

                return `
                    <div class="card bg-white rounded-2xl shadow-md mb-6 transition-all duration-300" data-id="${section.id}">
                        <div class="card-header p-6 cursor-pointer flex justify-between items-start gap-4">
                            <div>
                                <h2 class="text-xl font-bold text-[#2F3C7E]">${section.title}</h2>
                                <p class="text-sm text-gray-500 mt-1">${section.info}</p>
                            </div>
                            <button class="edit-btn text-[#4A90E2] font-semibold flex-shrink-0">Editar</button>
                        </div>
                        <div class="summary-content px-6 pb-6 text-gray-600 italic truncate">Nenhum conteúdo salvo.</div>
                        <div class="card-content px-6">
                            ${fieldsHTML}
                            <div class="flex justify-end py-4">
                                <button class="save-btn action-button text-white font-semibold py-2 px-8 rounded-2xl shadow-md transition-transform duration-300" data-section="${section.id}">Salvar</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            formContainer.innerHTML = sections.map(createCardHTML).join('');

            const autoSave = () => localStorage.setItem('ejaProjectData', JSON.stringify(projectData));

            const loadData = (data) => {
                projectData = data || {};
                Object.keys(projectData).forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) element.value = projectData[fieldId];
                });
                updateAllSummaries();
            };

            const loadFromLocalStorage = () => {
                const savedData = localStorage.getItem('ejaProjectData');
                if (savedData) loadData(JSON.parse(savedData));
            };

            function updateSummary(sectionId) {
                const card = formContainer.querySelector(`.card[data-id="${sectionId}"]`);
                if (!card) return;
                const summaryEl = card.querySelector('.summary-content');
                const sectionFields = sections.find(s => s.id === sectionId).fields;
                let summaryText = sectionFields.map(field => projectData[field.id] || '').join(' ').trim();

                if (summaryText) {
                    summaryEl.textContent = summaryText;
                    summaryEl.classList.remove('italic', 'text-gray-400');
                } else {
                    summaryEl.textContent = 'Nenhum conteúdo salvo.';
                    summaryEl.classList.add('italic', 'text-gray-400');
                }
            }
            
            const updateAllSummaries = () => sections.forEach(section => updateSummary(section.id));

            formContainer.addEventListener('click', (e) => {
                const cardHeader = e.target.closest('.card-header');
                const editBtn = e.target.closest('.edit-btn');
                const saveBtn = e.target.closest('.save-btn');
                
                if (cardHeader || editBtn) {
                    (cardHeader || editBtn).closest('.card').classList.toggle('expanded');
                }
                
                if (saveBtn) {
                    const sectionId = saveBtn.dataset.section;
                    const card = saveBtn.closest('.card');
                    const sectionFields = sections.find(s => s.id === sectionId).fields;

                    sectionFields.forEach(field => {
                        const inputElement = document.getElementById(field.id);
                        if (inputElement) projectData[field.id] = inputElement.value;
                    });

                    autoSave();
                    updateSummary(sectionId);
                    card.classList.remove('expanded');
                    showNotification('Salvo com sucesso!', 'success');
                }
            });

            function showNotification(message, type = 'error') {
                const notification = document.getElementById('notification');
                const notificationMessage = document.getElementById('notification-message');
                
                notificationMessage.textContent = message;
                notification.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-2xl shadow-lg transition-transform transform z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                notification.classList.remove('translate-x-[150%]');
                setTimeout(() => notification.classList.add('translate-x-[150%]'), 3000);
            }

            function validateProject() {
                if (! (projectData.titulo_projeto || '').trim()) {
                    showNotification('Por favor, preencha o "Título do projeto" antes de exportar.');
                    const requiredCard = document.querySelector('.card[data-id="acao_educativa"]');
                    if (requiredCard && !requiredCard.classList.contains('expanded')) {
                        requiredCard.classList.add('expanded');
                    }
                    document.getElementById('titulo_projeto')?.focus();
                    return false;
                }
                return true;
            }

            // --- Menu and Actions Logic ---

            // Mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const menuOpenIcon = document.getElementById('menu-open-icon');
            const menuCloseIcon = document.getElementById('menu-close-icon');

            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                menuOpenIcon.classList.toggle('hidden');
                menuCloseIcon.classList.toggle('hidden');
            });

            // JSON Import
            const fileInput = document.getElementById('json-file-input');
            const handleImport = () => fileInput.click();
            
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        loadData(JSON.parse(e.target.result));
                        autoSave();
                        showNotification('Projeto importado com sucesso!', 'success');
                    } catch (error) {
                        showNotification('Erro ao ler o arquivo JSON.');
                    }
                };
                reader.readAsText(file);
                fileInput.value = '';
            });

            // JSON Export
            const handleExportJson = () => {
                if (!validateProject()) return;
                const title = projectData.titulo_projeto || 'sem_titulo';
                const dataStr = JSON.stringify(projectData, null, 4);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', `projeto-eja-${title.replace(/ /g, '_')}.json`);
                link.click();
            };
            
            // PDF Generation
            const generatePdfBlob = async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const pageMargin = 20;
                const pageContentWidth = doc.internal.pageSize.getWidth() - (pageMargin * 2);
                let yPos = pageMargin;

                const addWrappedText = (text, size, style, spaceAfter) => {
                    doc.setFontSize(size);
                    doc.setFont('helvetica', style);
                    const lines = doc.splitTextToSize(text || 'Não preenchido', pageContentWidth);
                    const pageHeight = doc.internal.pageSize.getHeight() - pageMargin;

                    lines.forEach(line => {
                        if (yPos > pageHeight) {
                            doc.addPage();
                            yPos = pageMargin;
                        }
                        doc.text(line, pageMargin, yPos);
                        yPos += (size * 0.5);
                    });
                    yPos += spaceAfter;
                };
                
                // Title Page
                addWrappedText('PROJETO DA AÇÃO EDUCATIVA EM EJA', 22, 'bold', 20);
                addWrappedText(projectData.titulo_projeto || 'Título não definido', 16, 'normal', 50);
                addWrappedText(`Estagiário(a): ${projectData.estagiario || ''}`, 12, 'normal', 0);
                
                doc.addPage();
                yPos = pageMargin;

                // Content
                for (const section of sections) {
                    if (yPos > doc.internal.pageSize.getHeight() - pageMargin - 20) {
                        doc.addPage();
                        yPos = pageMargin;
                    }
                    addWrappedText(section.title, 14, 'bold', 8);
                    const content = section.fields.length > 1 ?
                        section.fields.map(f => `${f.label}:\n${projectData[f.id] || ''}`).join('\n\n') :
                        projectData[section.fields[0].id] || '';
                    addWrappedText(content, 12, 'normal', 15);
                }

                return doc.output('blob');
            };

            // PDF Export
            const handleExportPdf = async () => {
                if (!validateProject()) return;
                document.getElementById('loading-overlay').classList.remove('hidden');
                const blob = await generatePdfBlob();
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Projeto_EJA_${(projectData.titulo_projeto || 'sem_titulo').replace(/ /g, '_')}.pdf`;
                link.click();
                URL.revokeObjectURL(url);
                document.getElementById('loading-overlay').classList.add('hidden');
            };

            // PDF Share
            const handleSharePdf = async () => {
                if (!validateProject()) return;
                document.getElementById('loading-overlay').classList.remove('hidden');
                const blob = await generatePdfBlob();
                const fileName = `Projeto_EJA_${(projectData.titulo_projeto || 'sem_titulo').replace(/ /g, '_')}.pdf`;
                const file = new File([blob], fileName, { type: 'application/pdf' });
                
                try {
                    await navigator.share({
                        files: [file],
                        title: `Projeto EJA: ${projectData.titulo_projeto}`,
                        text: 'Confira o projeto da ação educativa em EJA.'
                    });
                } catch (error) {
                   if (error.name !== 'AbortError') {
                        showNotification('Erro ao compartilhar o arquivo.');
                        console.error('Share error:', error);
                   }
                } finally {
                    document.getElementById('loading-overlay').classList.add('hidden');
                }
            };
            
            // --- Event Binding ---
            const actionMap = {
                'import-json': handleImport,
                'export-json': handleExportJson,
                'export-pdf': handleExportPdf,
                'share-pdf': handleSharePdf,
            };

            ['desktop', 'mobile'].forEach(device => {
                Object.keys(actionMap).forEach(action => {
                    const btn = document.getElementById(`${action}-btn-${device}`);
                    if (btn) btn.addEventListener('click', actionMap[action]);
                });
            });

            // Search
            ['desktop', 'mobile'].forEach(device => {
                const searchInput = document.getElementById(`search-input-${device}`);
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    document.querySelectorAll('.card').forEach(card => {
                        const cardText = card.innerText.toLowerCase();
                        card.classList.toggle('hidden', !cardText.includes(searchTerm));
                    });
                });
            });

            // Conditionally show share button
            const dummyFile = new File([""], "dummy.pdf", { type: "application/pdf" });
            if (navigator.canShare && navigator.canShare({ files: [dummyFile] })) {
                document.getElementById('share-pdf-btn-desktop').classList.remove('hidden');
                document.getElementById('share-pdf-btn-mobile').classList.remove('hidden');
            }
            
            // Initial load
            loadFromLocalStorage();
        });
    </script>
</body>
</html>

