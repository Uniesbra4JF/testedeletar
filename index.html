<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto da Ação Educativa em EJA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Custom styles and animations */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F7F9FC;
        }
        
        .card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.7s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease-out;
            opacity: 0;
            visibility: hidden;
        }

        .card.expanded .card-content {
            max-height: 2000px; /* Adjust as needed for content */
            opacity: 1;
            visibility: visible;
        }

        .card .summary-content {
            display: block;
        }

        .card.expanded .summary-content {
            display: none;
        }

        .action-button {
            background-image: linear-gradient(to right, #4A90E2, #7B61FF);
        }

        .action-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .loader {
            border-top-color: #2F3C7E;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Notification Modal -->
    <div id="notification" class="fixed top-5 right-5 bg-red-500 text-white py-3 px-6 rounded-2xl shadow-lg transition-transform transform translate-x-[150%] z-50">
        <p id="notification-message"></p>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
        <p class="text-white text-xl ml-4">Gerando PDF...</p>
    </div>

    <!-- Header / Menu -->
    <header class="bg-white shadow-sm sticky top-0 z-40 py-4 px-4 sm:px-8">
        <div class="container mx-auto flex justify-between items-center gap-4">
            <h1 class="text-xl sm:text-2xl font-bold text-[#2F3C7E] whitespace-nowrap">Projeto EJA</h1>
            
            <div class="flex flex-1 justify-end items-center gap-2 sm:gap-4">
                 <input type="search" id="search-input" placeholder="Buscar..." class="w-full max-w-xs px-4 py-2 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-[#4A90E2] focus:outline-none transition">
                <button id="import-json-btn" class="action-button text-white font-semibold py-2 px-5 rounded-2xl shadow-md transition-transform duration-300">Importar JSON</button>
                <input type="file" id="json-file-input" class="hidden" accept=".json">
                <button id="export-json-btn" class="action-button text-white font-semibold py-2 px-5 rounded-2xl shadow-md transition-transform duration-300">Exportar JSON</button>
                <button id="export-pdf-btn" class="action-button text-white font-semibold py-2 px-5 rounded-2xl shadow-md transition-transform duration-300">Exportar PDF</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="project-form" class="container mx-auto p-4 sm:p-8">
        <!-- Cards will be dynamically inserted here by JavaScript -->
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const formContainer = document.getElementById('project-form');
            
            // Structure of the project sections
            const sections = [
                { id: 'identificacao', title: '1. Identificação do Projeto da Ação Educativa em EJA', info: 'Preencha os dados de identificação do estagiário e do local da ação.', fields: [
                    { id: 'estagiario', label: 'Estagiário(a)', type: 'input' },
                    { id: 'local_acao', label: 'Local da ação educativa', type: 'input' },
                    { id: 'gestor_local', label: 'Gestor do local da ação educativa', type: 'input' },
                    { id: 'endereco', label: 'Endereço', type: 'input' }
                ]},
                { id: 'introducao', title: '2. Introdução', info: 'Descreva o local da ação, seu histórico, estrutura física, humana e a atuação da gestão.', fields: [{ id: 'introducao_text', type: 'textarea' }] },
                { id: 'objetivos', title: '3. Objetivos', info: 'Defina o que se pretende alcançar com o projeto.', fields: [
                    { id: 'objetivo_geral', label: '3.1 Objetivo Geral', info: 'Informe um objetivo de forma geral (Ex: Contribuir, Possibilitar...).', type: 'textarea' },
                    { id: 'objetivos_especificos', label: '3.2 Objetivos Específicos', info: 'Informe três objetivos de forma específica.', type: 'textarea' }
                ]},
                { id: 'justificativa', title: '4. Justificativa do Tema do Projeto', info: 'Descreva as observações e dificuldades encontradas que levaram à escolha do tema.', fields: [{ id: 'justificativa_text', type: 'textarea' }] },
                { id: 'revisao_literatura', title: '5. Revisão da Literatura', info: 'Fundamente teoricamente o tema do projeto com base em autores e obras relevantes.', fields: [{ id: 'revisao_literatura_text', type: 'textarea' }] },
                { id: 'metodologia', title: '6. Metodologia', info: 'Mencione o que, como, quando e onde você vai aplicar sua ação educativa.', fields: [{ id: 'metodologia_text', type: 'textarea' }] },
                { id: 'acao_educativa', title: '7. Ação Educativa – Onde, Quando, O que e Com Quem foi aplicada', info: 'Detalhe a aplicação da sua ação educativa.', fields: [
                    { id: 'data_acao', label: 'Data', type: 'input' },
                    { id: 'publico_alvo', label: 'Público-alvo', type: 'input' },
                    { id: 'turno', label: 'Turno', type: 'input' },
                    { id: 'semestre_atual', label: 'Semestre atual', type: 'input' },
                    { id: 'local_aplicacao', label: 'Local', type: 'input' },
                    { id: 'titulo_projeto', label: 'Título do projeto (campo obrigatório)', type: 'input', required: true }
                ]},
                { id: 'recursos', title: '7.1 Recursos a serem utilizados', info: 'Liste todos os materiais e recursos que serão usados na ação educativa.', fields: [{ id: 'recursos_text', type: 'textarea' }] },
                { id: 'referencias', title: 'Referências utilizadas', info: 'Liste todas as referências (livros, textos) usadas na construção do projeto, seguindo as normas da ABNT.', fields: [{ id: 'referencias_text', type: 'textarea' }] },
                { id: 'avaliacao', title: '8. Avaliação', info: 'Descreva como os resultados do projeto serão avaliados.', fields: [{ id: 'avaliacao_text', type: 'textarea' }] },
                { id: 'resultados_esperados', title: '9. Resultados esperados', info: 'Descreva o que se espera alcançar e melhorar com a aplicação do projeto.', fields: [{ id: 'resultados_esperados_text', type: 'textarea' }] },
                { id: 'anexos_apendices', title: 'Anexos/Apêndices', info: 'Anexos: materiais prontos utilizados. Apêndices: materiais produzidos por você (fotos, atividades).', fields: [{ id: 'anexos_apendices_text', type: 'textarea' }] }
            ];

            let projectData = {};

            // Function to generate the HTML for each card
            function createCardHTML(section) {
                const fieldsHTML = section.fields.map(field => `
                    <div class="mb-4">
                        ${field.label ? `<label for="${field.id}" class="block text-md font-semibold text-[#2F3C7E] mb-2">${field.label}${field.required ? '<span class="text-red-500">*</span>' : ''}</label>` : ''}
                        ${field.info && field.label ? `<p class="text-sm text-gray-500 mb-2">${field.info}</p>` : ''}
                        ${field.type === 'input' ? 
                            `<input type="text" id="${field.id}" data-section="${section.id}" class="w-full p-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-[#4A90E2] focus:outline-none transition bg-gray-50">` : 
                            `<textarea id="${field.id}" data-section="${section.id}" rows="8" class="w-full p-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-[#4A90E2] focus:outline-none transition bg-gray-50"></textarea>`
                        }
                    </div>
                `).join('');

                return `
                    <div class="card bg-white rounded-2xl shadow-md mb-6 transition-all duration-300" data-id="${section.id}">
                        <div class="card-header p-6 cursor-pointer flex justify-between items-start gap-4">
                            <div>
                                <h2 class="text-xl font-bold text-[#2F3C7E]">${section.title}</h2>
                                <p class="text-sm text-gray-500 mt-1">${section.info}</p>
                            </div>
                            <button class="edit-btn text-[#4A90E2] font-semibold flex-shrink-0">Editar</button>
                        </div>
                        <div class="summary-content px-6 pb-6 text-gray-600 italic truncate">
                             Nenhum conteúdo salvo.
                        </div>
                        <div class="card-content px-6">
                            ${fieldsHTML}
                            <div class="flex justify-end py-4">
                                <button class="save-btn action-button text-white font-semibold py-2 px-8 rounded-2xl shadow-md transition-transform duration-300" data-section="${section.id}">
                                    Salvar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Populate the form with cards
            formContainer.innerHTML = sections.map(createCardHTML).join('');

            // --- Event Listeners and Functions ---
            
            // Autosave to localStorage
            const autoSave = () => {
                localStorage.setItem('ejaProjectData', JSON.stringify(projectData));
            };

            // Load data from localStorage
            const loadData = (data) => {
                projectData = data || {};
                Object.keys(projectData).forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = projectData[fieldId];
                    }
                });
                updateAllSummaries();
            };

            const loadFromLocalStorage = () => {
                const savedData = localStorage.getItem('ejaProjectData');
                if (savedData) {
                    loadData(JSON.parse(savedData));
                }
            };

            // Update card summary
            function updateSummary(sectionId) {
                const card = formContainer.querySelector(`.card[data-id="${sectionId}"]`);
                if (!card) return;
                const summaryEl = card.querySelector('.summary-content');
                
                const sectionFields = sections.find(s => s.id === sectionId).fields;
                let summaryText = sectionFields.map(field => projectData[field.id] || '')
                                               .join(' ')
                                               .trim();

                if (summaryText) {
                    summaryEl.textContent = summaryText;
                    summaryEl.classList.remove('italic', 'text-gray-400');
                } else {
                    summaryEl.textContent = 'Nenhum conteúdo salvo.';
                    summaryEl.classList.add('italic', 'text-gray-400');
                }
            }
            
            function updateAllSummaries() {
                sections.forEach(section => updateSummary(section.id));
            }

            // Card toggle functionality
            formContainer.addEventListener('click', (e) => {
                const cardHeader = e.target.closest('.card-header');
                const editBtn = e.target.closest('.edit-btn');
                const saveBtn = e.target.closest('.save-btn');
                
                if (cardHeader || editBtn) {
                    const card = (cardHeader || editBtn).closest('.card');
                    card.classList.toggle('expanded');
                }
                
                if (saveBtn) {
                    const sectionId = saveBtn.dataset.section;
                    const card = saveBtn.closest('.card');
                    const sectionFields = sections.find(s => s.id === sectionId).fields;

                    sectionFields.forEach(field => {
                        const inputElement = document.getElementById(field.id);
                        if (inputElement) {
                            projectData[field.id] = inputElement.value;
                        }
                    });

                    autoSave();
                    updateSummary(sectionId);
                    card.classList.remove('expanded');
                    showNotification('Salvo com sucesso!', 'success');
                }
            });

            // Show notification
            function showNotification(message, type = 'error') {
                const notification = document.getElementById('notification');
                const notificationMessage = document.getElementById('notification-message');
                
                notificationMessage.textContent = message;
                notification.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-2xl shadow-lg transition-transform transform z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                
                notification.classList.remove('translate-x-[150%]');
                notification.classList.add('translate-x-0');

                setTimeout(() => {
                    notification.classList.remove('translate-x-0');
                    notification.classList.add('translate-x-[150%]');
                }, 3000);
            }

            // Validation
            function validateProject() {
                const title = projectData.titulo_projeto || '';
                if (!title.trim()) {
                    showNotification('Por favor, preencha o "Título do projeto" antes de exportar.');
                    const requiredCard = document.querySelector('.card[data-id="acao_educativa"]');
                    if (requiredCard && !requiredCard.classList.contains('expanded')) {
                        requiredCard.classList.add('expanded');
                    }
                    document.getElementById('titulo_projeto')?.focus();
                    return false;
                }
                return true;
            }

            // JSON Import/Export
            const importBtn = document.getElementById('import-json-btn');
            const fileInput = document.getElementById('json-file-input');
            const exportJsonBtn = document.getElementById('export-json-btn');

            importBtn.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        loadData(importedData);
                        autoSave();
                        showNotification('Projeto importado com sucesso!', 'success');
                    } catch (error) {
                        showNotification('Erro ao ler o arquivo JSON. Verifique o formato.');
                        console.error("JSON Parse Error:", error);
                    }
                };
                reader.readAsText(file);
                fileInput.value = ''; // Reset for next import
            });

            exportJsonBtn.addEventListener('click', () => {
                if (!validateProject()) return;
                const title = projectData.titulo_projeto || 'sem_titulo';
                const dataStr = JSON.stringify(projectData, null, 4);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `projeto-eja-${title.replace(/ /g, '_')}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            });

            // PDF Export
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const loadingOverlay = document.getElementById('loading-overlay');

            exportPdfBtn.addEventListener('click', async () => {
                if (!validateProject()) return;

                loadingOverlay.classList.remove('hidden');

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                
                const pageMargin = 20;
                const pageContentWidth = doc.internal.pageSize.getWidth() - (pageMargin * 2);
                const pageContentHeight = doc.internal.pageSize.getHeight() - pageMargin;
                let yPos = pageMargin;

                const addWrappedText = ({ text, style = 'normal', size = 12, spaceAfter = 5 }) => {
                    doc.setFont('helvetica', style);
                    doc.setFontSize(size);
                    const lines = doc.splitTextToSize(text || 'Não preenchido', pageContentWidth);
                    
                    lines.forEach(line => {
                        if (yPos > pageContentHeight) {
                            doc.addPage();
                            yPos = pageMargin;
                        }
                        doc.text(line, pageMargin, yPos);
                        yPos += (size * 0.4); // Adjust line height based on font size
                    });
                    yPos += spaceAfter;
                };

                // --- Building the PDF ---
                // Title Page
                yPos = 80;
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text('PROJETO DA AÇÃO EDUCATIVA EM EJA', doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
                yPos += 20;

                doc.setFontSize(16);
                doc.setFont('helvetica', 'normal');
                doc.text(projectData.titulo_projeto || 'Título não definido', doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
                yPos += 50;

                doc.text(`Estagiário(a): ${projectData.estagiario || ''}`, doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
                
                doc.addPage();
                yPos = pageMargin;
                
                // Add sections to PDF
                for (const section of sections) {
                     if (yPos > pageContentHeight - 20) { // Check space for header
                        doc.addPage();
                        yPos = pageMargin;
                    }
                    
                    addWrappedText({ text: section.title, style: 'bold', size: 14, spaceAfter: 8 });

                    let content = '';
                    if (section.fields.length > 1) {
                        content = section.fields.map(field => `${field.label}:\n${projectData[field.id] || ''}`).join('\n\n');
                    } else {
                        content = projectData[section.fields[0].id] || '';
                    }

                    addWrappedText({ text: content, size: 12, spaceAfter: 15 });
                }

                const pdfFileName = `Projeto_EJA_${(projectData.titulo_projeto || 'sem_titulo').replace(/ /g, '_')}.pdf`;
                doc.save(pdfFileName);
                
                loadingOverlay.classList.add('hidden');
            });

            // Search Functionality
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const allCards = document.querySelectorAll('.card');

                allCards.forEach(card => {
                    const sectionId = card.dataset.id;
                    const section = sections.find(s => s.id === sectionId);
                    
                    const titleMatch = section.title.toLowerCase().includes(searchTerm);
                    
                    const contentMatch = section.fields.some(field => {
                        const content = projectData[field.id] || '';
                        return content.toLowerCase().includes(searchTerm);
                    });
                    
                    if (searchTerm === '' || titleMatch || contentMatch) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                });
            });

            // Initial load
            loadFromLocalStorage();
        });
    </script>
</body>
</html>

