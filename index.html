<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto e Relatório - Ação Educativa em EJA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Custom styles and animations */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F7F9FC;
        }
        
        .card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.7s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease-out;
            opacity: 0;
            visibility: hidden;
        }

        .card.expanded .card-content {
            max-height: 2000px;
            opacity: 1;
            visibility: visible;
        }

        .action-button {
            background-image: linear-gradient(to right, #4A90E2, #7B61FF);
        }
        
        .loader {
            border-top-color: #2F3C7E;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Notification Modal -->
    <div id="notification" class="fixed top-5 right-5 bg-red-500 text-white py-3 px-6 rounded-2xl shadow-lg transition-transform transform translate-x-[150%] z-50">
        <p id="notification-message"></p>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
        <p class="text-white text-xl ml-4">Gerando PDF...</p>
    </div>

    <!-- Header / Menu -->
    <header class="bg-white shadow-sm sticky top-0 z-40 py-4 px-4 sm:px-8">
        <div class="container mx-auto flex justify-between items-center gap-4">
            <h1 id="page-title" class="text-xl sm:text-2xl font-bold text-[#2F3C7E] whitespace-nowrap">Projeto EJA</h1>
            
            <nav class="hidden md:flex flex-1 justify-end items-center gap-2">
                <input type="search" id="search-input-desktop" placeholder="Buscar..." class="w-full max-w-xs px-4 py-2 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-[#4A90E2] focus:outline-none transition">
                <button data-action="toggle-page" class="action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md text-sm">Relatório Final</button>
                <button data-action="import-json" class="action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md text-sm">Importar JSON</button>
                <button data-action="export-json" class="action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md text-sm">Exportar JSON</button>
                <button data-action="export-pdf" class="action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md text-sm">Exportar PDF</button>
                <button data-action="share-pdf" class="action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md text-sm hidden">Compartilhar PDF</button>
            </nav>

            <div class="md:hidden">
                <button id="mobile-menu-button" class="p-2 rounded-md text-[#2F3C7E]"><svg class="h-6 w-6" id="menu-open-icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg><svg class="h-6 w-6 hidden" id="menu-close-icon" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
        </div>

        <div id="mobile-menu" class="md:hidden hidden bg-white shadow-lg absolute top-full right-0 w-full">
            <div class="px-4 pt-2 pb-4 space-y-3">
                 <input type="search" id="search-input-mobile" placeholder="Buscar..." class="w-full px-4 py-2 border border-gray-300 rounded-2xl">
                 <button data-action="toggle-page" class="w-full text-left action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md">Relatório Final</button>
                 <button data-action="import-json" class="w-full text-left action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md">Importar JSON</button>
                 <button data-action="export-json" class="w-full text-left action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md">Exportar JSON</button>
                 <button data-action="export-pdf" class="w-full text-left action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md">Exportar PDF</button>
                 <button data-action="share-pdf" class="w-full text-left action-button text-white font-semibold py-2 px-4 rounded-2xl shadow-md hidden">Compartilhar PDF</button>
            </div>
        </div>
        <input type="file" id="json-file-input" class="hidden" accept=".json">
    </header>

    <!-- Page: Project -->
    <main id="page-project" class="container mx-auto p-4 sm:p-8">
        <!-- Project cards will be dynamically inserted here -->
    </main>
    
    <!-- Page: Report -->
    <main id="page-report" class="container mx-auto p-4 sm:p-8 hidden">
        <!-- Report cards will be dynamically inserted here -->
    </main>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DATA STRUCTURES ---
            const projectSections = [
                { id: 'identificacao', title: '1. Identificação do Projeto', fields: [{ id: 'estagiario', label: 'Estagiário(a)'}, { id: 'local_acao', label: 'Local da ação'}, { id: 'gestor_local', label: 'Gestor do local'}, { id: 'endereco', label: 'Endereço'}] },
                { id: 'introducao', title: '2. Introdução', fields: [{ id: 'introducao_text'}] }, { id: 'objetivos', title: '3. Objetivos', fields: [{ id: 'objetivo_geral', label: '3.1 Objetivo Geral'}, { id: 'objetivos_especificos', label: '3.2 Objetivos Específicos'}] }, { id: 'justificativa', title: '4. Justificativa', fields: [{ id: 'justificativa_text'}] }, { id: 'revisao_literatura', title: '5. Revisão da Literatura', fields: [{ id: 'revisao_literatura_text'}] }, { id: 'metodologia', title: '6. Metodologia', fields: [{ id: 'metodologia_text'}] }, { id: 'acao_educativa', title: '7. Ação Educativa', fields: [{ id: 'data_acao', label: 'Data'}, { id: 'publico_alvo', label: 'Público-alvo'}, { id: 'turno', label: 'Turno'}, { id: 'semestre_atual', label: 'Semestre atual'}, { id: 'local_aplicacao', label: 'Local'}, { id: 'titulo_projeto', label: 'Título do projeto (obrigatório)', required: true }] }, { id: 'recursos', title: '7.1 Recursos', fields: [{ id: 'recursos_text'}] }, { id: 'referencias_proj', title: 'Referências (Projeto)', fields: [{ id: 'referencias_proj_text'}] }, { id: 'avaliacao', title: '8. Avaliação', fields: [{ id: 'avaliacao_text'}] }, { id: 'resultados_esperados', title: '9. Resultados esperados', fields: [{ id: 'resultados_esperados_text'}] }, { id: 'anexos_apendices_proj', title: 'Anexos/Apêndices (Projeto)', fields: [{ id: 'anexos_apendices_proj_text'}] }
            ];

            const reportSections = [
                { id: 'intro_report', title: '1. Introdução do Relatório', info: 'Apresente o documento, o tipo de estágio, curso, instituição, local e orientador.', fields: [{ id: 'intro_report_text' }] },
                { id: 'revisao_report', title: '2. Revisão de Literatura', info: 'Levantamento bibliográfico sobre a temática "Estágio Supervisionado em EJA".', fields: [{ id: 'revisao_report_text' }] },
                { id: 'relato_experiencia', title: '3. Relato de Experiência', info: 'Descreva sua experiência completa com o estágio em EJA, do início ao fim, incluindo desafios.', fields: [{ id: 'relato_experiencia_text' }] },
                { id: 'conclusao_report', title: '4. Conclusão', info: 'Observações gerais, resultados obtidos, dificuldades, aprendizados e reflexões sobre a prática.', fields: [{ id: 'conclusao_report_text' }] },
                { id: 'referencias_report', title: 'Referências (Relatório)', info: 'Liste os autores e obras citados ao longo do relatório.', fields: [{ id: 'referencias_report_text' }] },
                { id: 'anexos_apendices_report', title: 'Anexos/Apêndices (Relatório)', info: 'Inclua a carta de apresentação, termo de compromisso, projeto, ficha de frequência, etc.', fields: [{ id: 'anexos_apendices_report_text' }] }
            ];
            
            let projectData = {};
            let reportData = {};
            let currentPage = 'project'; // 'project' or 'report'

            // --- UI & PAGE LOGIC ---
            const pageTitleEl = document.getElementById('page-title');
            const pageProjectEl = document.getElementById('page-project');
            const pageReportEl = document.getElementById('page-report');
            const togglePageBtns = document.querySelectorAll('[data-action="toggle-page"]');

            const showPage = (pageId) => {
                currentPage = pageId;
                if (pageId === 'project') {
                    pageProjectEl.classList.remove('hidden');
                    pageReportEl.classList.add('hidden');
                    pageTitleEl.textContent = 'Projeto EJA';
                    togglePageBtns.forEach(btn => btn.textContent = 'Relatório Final');
                } else {
                    pageProjectEl.classList.add('hidden');
                    pageReportEl.classList.remove('hidden');
                    pageTitleEl.textContent = 'Relatório Final';
                    togglePageBtns.forEach(btn => btn.textContent = 'Voltar ao Projeto');
                }
                window.scrollTo(0, 0);
            };

            // --- DYNAMIC CONTENT GENERATION ---
            const createCardHTML = (section, page) => {
                const fieldsHTML = section.fields.map(field => `
                    <div class="mb-4">
                        ${field.label ? `<label for="${field.id}" class="block text-md font-semibold text-[#2F3C7E] mb-2">${field.label}${field.required ? '<span class="text-red-500">*</span>' : ''}</label>` : ''}
                        <textarea id="${field.id}" data-page="${page}" rows="8" class="w-full p-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-[#4A90E2] focus:outline-none transition bg-gray-50"></textarea>
                    </div>`).join('');

                return `
                    <div class="card bg-white rounded-2xl shadow-md mb-6" data-id="${section.id}" data-page="${page}">
                        <div class="card-header p-6 cursor-pointer flex justify-between items-start gap-4">
                            <div><h2 class="text-xl font-bold text-[#2F3C7E]">${section.title}</h2><p class="text-sm text-gray-500 mt-1">${section.info || ''}</p></div>
                            <button class="edit-btn text-[#4A90E2] font-semibold flex-shrink-0">Editar</button>
                        </div>
                        <div class="summary-content px-6 pb-6 text-gray-600 italic truncate">Nenhum conteúdo.</div>
                        <div class="card-content px-6">${fieldsHTML}<div class="flex justify-end py-4"><button class="save-btn action-button text-white font-semibold py-2 px-8 rounded-2xl">Salvar</button></div></div>
                    </div>`;
            };
            
            pageProjectEl.innerHTML = projectSections.map(s => createCardHTML(s, 'project')).join('');
            pageReportEl.innerHTML = reportSections.map(s => createCardHTML(s, 'report')).join('');

            // --- DATA HANDLING ---
            const autoSave = () => {
                if (currentPage === 'project') localStorage.setItem('ejaProjectData', JSON.stringify(projectData));
                else localStorage.setItem('ejaReportData', JSON.stringify(reportData));
            };

            const loadData = () => {
                const savedProject = localStorage.getItem('ejaProjectData');
                const savedReport = localStorage.getItem('ejaReportData');
                projectData = savedProject ? JSON.parse(savedProject) : {};
                reportData = savedReport ? JSON.parse(savedReport) : {};

                [...projectSections, ...reportSections].forEach(section => {
                    const data = section.id.includes('_report') || section.id.includes('relato') ? reportData : projectData;
                    section.fields.forEach(field => {
                        const el = document.getElementById(field.id);
                        if (el) el.value = data[field.id] || '';
                    });
                    updateSummary(section.id);
                });
            };

            function updateSummary(sectionId) {
                const card = document.querySelector(`.card[data-id="${sectionId}"]`);
                if (!card) return;

                const page = card.dataset.page;
                const sections = page === 'project' ? projectSections : reportSections;
                const data = page === 'project' ? projectData : reportData;

                const summaryEl = card.querySelector('.summary-content');
                const sectionFields = sections.find(s => s.id === sectionId).fields;
                let summaryText = sectionFields.map(field => data[field.id] || '').join(' ').trim();

                summaryEl.textContent = summaryText ? summaryText : 'Nenhum conteúdo.';
                summaryEl.classList.toggle('italic', !summaryText);
            }

            // --- EVENT LISTENERS ---
            document.body.addEventListener('click', (e) => {
                const cardHeader = e.target.closest('.card-header, .edit-btn');
                const saveBtn = e.target.closest('.save-btn');

                if (cardHeader) cardHeader.closest('.card').classList.toggle('expanded');
                
                if (saveBtn) {
                    const card = saveBtn.closest('.card');
                    const page = card.dataset.page;
                    const sections = page === 'project' ? projectSections : reportSections;
                    const data = page === 'project' ? projectData : reportData;
                    const section = sections.find(s => s.id === card.dataset.id);

                    section.fields.forEach(field => {
                        data[field.id] = document.getElementById(field.id).value;
                    });
                    
                    autoSave();
                    updateSummary(section.id);
                    card.classList.remove('expanded');
                    showNotification('Salvo com sucesso!', 'success');
                }
            });
            
            const showNotification = (message, type = 'error') => {
                const el = document.getElementById('notification');
                el.querySelector('p').textContent = message;
                el.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-2xl shadow-lg transition-transform transform z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                el.classList.remove('translate-x-[150%]');
                setTimeout(() => el.classList.add('translate-x-[150%]'), 3000);
            };

            const validateProject = () => {
                if (!(projectData.titulo_projeto || '').trim()) {
                    showNotification('O "Título do projeto" é obrigatório.');
                    showPage('project');
                    const card = document.querySelector('.card[data-id="acao_educativa"]');
                    if(card && !card.classList.contains('expanded')) card.classList.add('expanded');
                    document.getElementById('titulo_projeto')?.focus();
                    return false;
                }
                return true;
            };

            // --- ACTIONS (Import, Export, Share) ---
            const fileInput = document.getElementById('json-file-input');
            const actions = {
                'toggle-page': () => showPage(currentPage === 'project' ? 'report' : 'project'),
                'import-json': () => fileInput.click(),
                'export-json': () => {
                    if (currentPage === 'project' && !validateProject()) return;
                    const data = currentPage === 'project' ? projectData : reportData;
                    const title = projectData.titulo_projeto || 'sem_titulo';
                    const filename = `${currentPage}-eja-${title.replace(/ /g, '_')}.json`;
                    
                    const a = document.createElement('a');
                    a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data, null, 4));
                    a.download = filename;
                    a.click();
                },
                'export-pdf': async () => {
                    if (currentPage === 'project' && !validateProject()) return;
                    document.getElementById('loading-overlay').classList.remove('hidden');
                    const blob = await generatePdfBlob();
                    const title = projectData.titulo_projeto || 'sem_titulo';
                    const filename = `${currentPage === 'project' ? 'Projeto' : 'Relatorio'}_EJA_${title.replace(/ /g, '_')}.pdf`;
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(a.href);
                    document.getElementById('loading-overlay').classList.add('hidden');
                },
                'share-pdf': async () => {
                    if (currentPage === 'project' && !validateProject()) return;
                    document.getElementById('loading-overlay').classList.remove('hidden');
                    const blob = await generatePdfBlob();
                    const title = projectData.titulo_projeto || 'sem_titulo';
                    const filename = `${currentPage === 'project' ? 'Projeto' : 'Relatorio'}_EJA_${title.replace(/ /g, '_')}.pdf`;
                    const file = new File([blob], filename, { type: 'application/pdf' });

                    try {
                        await navigator.share({ files: [file], title: `EJA: ${title}` });
                    } catch (error) {
                        if (error.name !== 'AbortError') showNotification('Erro ao compartilhar.');
                    } finally {
                        document.getElementById('loading-overlay').classList.add('hidden');
                    }
                }
            };

            document.body.addEventListener('click', e => {
                const action = e.target.dataset.action;
                if (actions[action]) actions[action]();
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (re) => {
                    try {
                        const data = JSON.parse(re.target.result);
                        if (currentPage === 'project') projectData = data; else reportData = data;
                        autoSave();
                        loadData();
                        showNotification('Importado com sucesso!', 'success');
                    } catch { showNotification('Erro ao ler arquivo JSON.'); }
                };
                reader.readAsText(file);
                fileInput.value = '';
            });

            const generatePdfBlob = async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'mm', format: 'a4' });
                const margin = 20;
                const width = doc.internal.pageSize.getWidth() - (margin * 2);
                let y = margin;

                const addText = (text, size, style, space) => {
                    if (y > doc.internal.pageSize.getHeight() - margin - 10) { doc.addPage(); y = margin; }
                    doc.setFontSize(size);
                    doc.setFont('helvetica', style);
                    const lines = doc.splitTextToSize(text || 'Não preenchido', width);
                    doc.text(lines, margin, y);
                    y += (lines.length * size * 0.4) + space;
                };

                const sections = currentPage === 'project' ? projectSections : reportSections;
                const data = currentPage === 'project' ? projectData : reportData;

                addText(currentPage === 'project' ? 'Projeto da Ação Educativa' : 'Relatório Final', 18, 'bold', 10);
                addText(projectData.titulo_projeto || 'Título não definido', 14, 'normal', 20);

                for (const section of sections) {
                    addText(section.title, 14, 'bold', 5);
                    const content = section.fields.map(f => (f.label ? `${f.label}:\n` : '') + (data[f.id] || '')).join('\n\n');
                    addText(content, 12, 'normal', 15);
                }
                return doc.output('blob');
            };

            // --- SEARCH & MENU ---
            document.querySelectorAll('#search-input-desktop, #search-input-mobile').forEach(input => {
                input.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    document.querySelectorAll(`.card[data-page="${currentPage}"]`).forEach(card => {
                        card.classList.toggle('hidden', !card.innerText.toLowerCase().includes(term));
                    });
                });
            });

            const mobileMenuBtn = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                document.getElementById('menu-open-icon').classList.toggle('hidden');
                document.getElementById('menu-close-icon').classList.toggle('hidden');
            });
            
            if (navigator.share && navigator.canShare({files: [new File([""], "t.pdf", {type:"application/pdf"})]})) {
                document.querySelectorAll('[data-action="share-pdf"]').forEach(b => b.classList.remove('hidden'));
            }

            loadData();
        });
    </script>
</body>
</html>

